{% extends 'base.html' %}
{% block title %}Panel · Pilates Studio{% endblock %}

{% block content %}

<!-- Özet Kartları -->
<div class="grid md:grid-cols-2 gap-6 mb-6">
  <!-- Bu ay katılım -->
  <div class="rounded-[22px] border border-white/55 bg-white/65 backdrop-blur-xl p-6 shadow-[0_20px_80px_-30px_rgba(0,0,0,.25)]">
    <div class="text-sm text-stone-500">Bu ay katıldığınız ders</div>
    <div class="mt-1 text-3xl font-semibold">{{ monthly_attended }}</div>
    <div class="mt-3 h-2 w-full rounded-full bg-white/70 ring-1 ring-white/60 shadow-inner overflow-hidden">
      <div class="h-full w-[{{ (monthly_attended*10)|int if monthly_attended else 0 }}%] min-w-[2%] rounded-full bg-gradient-to-r from-rose-300 via-fuchsia-300 to-violet-300"></div>
    </div>
  </div>

  <!-- Kalan seans hakkı -->
  <div class="rounded-[22px] border border-white/55 bg-white/65 backdrop-blur-xl p-6 shadow-[0_20px_80px_-30px_rgba(0,0,0,.25)]">
    <div class="text-sm text-stone-500">Kalan seans hakkınız</div>
    <div class="mt-1 text-3xl font-semibold">{{ credits_left }}</div>
    <p class="mt-2 text-xs text-stone-500">Seanslara katıldıkça hakkınız otomatik güncellenir.</p>
  </div>
</div>

<div class="grid lg:grid-cols-2 gap-6">
  <!-- Aktif Rezervasyonlarım -->
  <div class="rounded-[22px] border border-white/55 bg-white/65 backdrop-blur-xl p-6 shadow-[0_20px_80px_-30px_rgba(0,0,0,.25)]">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-lg">Aktif Rezervasyonlarım</h2>
      <a href="{{ url_for('list_sessions') }}" class="text-sm underline">Tüm seanslar →</a>
    </div>

    <div class="space-y-3">
      {% for r in my_active %}
      <div class="rounded-2xl bg-white/85 ring-1 ring-white/60 shadow-inner p-4 flex items-start justify-between gap-4">
        <div>
          <div class="flex flex-wrap items-center gap-2">
            <div class="font-medium">
              {{ r.session.date.strftime('%d.%m.%Y') }} · {{ r.session.time.strftime('%H:%M') }}
            </div>

            {# İptal talebi durumu etiketi #}
            {% if r.cancel_status == 'pending' %}
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-amber-200 text-amber-900">İptal beklemede</span>
            {% elif r.cancel_status == 'approved' %}
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-emerald-200 text-emerald-900">İptal onaylandı</span>
            {% elif r.cancel_status == 'rejected' %}
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-rose-200 text-rose-900">İptal reddedildi</span>
            {% endif %}
          </div>
          <div class="text-xs text-stone-500 mt-1">{{ r.session.notes or '—' }}</div>

          {% if r.cancel_status in ['pending','rejected'] and r.cancel_reason %}
            <div class="mt-2 text-[12px] text-stone-600">
              <span class="text-stone-500">İptal sebebi:</span> {{ r.cancel_reason }}
            </div>
          {% endif %}
        </div>

        <div class="flex flex-wrap gap-2 shrink-0">
          <!-- İptal Talebi (modal açar) -->
          <button type="button"
                  class="px-3 py-2 rounded-xl shadow text-sm
                         {% if r.cancel_status == 'pending' %} bg-stone-200 cursor-not-allowed opacity-60 {% else %} bg-rose-200 hover:shadow-md {% endif %}"
                  {% if r.cancel_status == 'pending' %}disabled{% else %}onclick="document.getElementById('cancelModal-{{ r.id }}').classList.remove('hidden')"{% endif %}>
            İptal Et
          </button>

          <!-- Saat Değiştir -->
          <a href="{{ url_for('move', reservation_id=r.id) }}"
             class="px-3 py-2 rounded-xl bg-[var(--lav)] shadow text-sm hover:shadow-md">
            Saat Değiştir
          </a>
        </div>
      </div>

      <!-- İptal Talebi Modal -->
      <div id="cancelModal-{{ r.id }}" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40">
        <div class="w-full max-w-md rounded-2xl bg-white p-5 shadow-lg">
          <h3 class="font-semibold mb-2">İptal Talebi</h3>
          <p class="text-sm text-stone-600 mb-3">
            Lütfen iptal sebebinizi yazın. Talebiniz eğitmen tarafından onaylandığında geçerli olacaktır.
          </p>
          <form method="post" action="{{ url_for('cancel_request', reservation_id=r.id) }}" class="space-y-3">
            <textarea name="reason" required class="w-full border rounded-xl p-3" rows="3"
                      placeholder="İptal sebebi..."></textarea>
            <div class="flex items-center justify-end gap-2">
              <button type="button" class="px-3 py-2 rounded-xl bg-stone-100"
                      onclick="document.getElementById('cancelModal-{{ r.id }}').classList.add('hidden')">
                Vazgeç
              </button>
              <button class="px-3 py-2 rounded-xl bg-rose-200 shadow">İptal Talebi Gönder</button>
            </div>
          </form>
        </div>
      </div>
      {% else %}
        <div class="text-sm text-stone-600">Aktif rezervasyonunuz yok.</div>
      {% endfor %}
    </div>
  </div>

  <!-- Yaklaşan Seanslar -->
  <div class="rounded-[22px] border border-white/55 bg-white/65 backdrop-blur-xl p-6 shadow-[0_20px_80px_-30px_rgba(0,0,0,.25)]">
    <h2 class="font-semibold text-lg mb-3">Yaklaşan Seanslar</h2>

    <div class="space-y-3">
      {% for s in upcoming %}
      <div class="rounded-2xl bg-white/85 ring-1 ring-white/60 shadow-inner p-4 flex items-center justify-between gap-4">
        <div>
          <div class="font-medium">
            {{ s.date.strftime('%d.%m.%Y') }} · {{ s.time.strftime('%H:%M') }}
          </div>
          <div class="text-xs text-stone-500">Kapasite: {{ s.capacity }} · Kalan: {{ s.spots_left }}</div>
        </div>
        <form method="post" action="{{ url_for('reserve', session_id=s.id) }}">
          <button class="px-3 py-2 rounded-xl bg-[var(--lav)] shadow text-sm hover:shadow-md
                        {% if s.spots_left==0 %} opacity-60 cursor-not-allowed {% endif %}"
                  {% if s.spots_left==0 %}disabled{% endif %}>
            Katıl
          </button>
        </form>
      </div>
      {% else %}
        <div class="text-sm text-stone-600">Seans bulunamadı.</div>
      {% endfor %}
    </div>
  </div>
</div>

{% endblock %}
