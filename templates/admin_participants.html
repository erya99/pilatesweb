{% extends 'base.html' %}
{% block title %}Katılımcılar · Pilates Studio{% endblock %}

{% block content %}
<div class="rounded-[22px] border border-white/55 bg-white/55 backdrop-blur-xl p-6 shadow-[0_20px_80px_-30px_rgba(0,0,0,.25)]">
  
  <!-- Üst bilgi -->
  <div class="flex items-start justify-between gap-4">
    <div>
      <h2 class="font-semibold mb-1 text-lg">
        {{ s.date.strftime('%d.%m.%Y') }} · {{ s.time.strftime('%H:%M') }} — Katılımcılar
      </h2>
      <div class="flex items-center gap-2">
        {% if s.completed %}
          <span class="text-xs px-2 py-1 rounded-full bg-green-200 text-green-800">Tamamlandı</span>
        {% else %}
          <span class="text-xs px-2 py-1 rounded-full bg-yellow-200 text-yellow-800">Planlandı</span>
        {% endif %}
        <span class="text-xs text-stone-500">Kapasite: {{ s.capacity }} · Kalan: {{ s.spots_left }}</span>
      </div>
    </div>
    <a href="{{ url_for('admin_sessions') }}"
       class="px-3 py-2 rounded-xl bg-gradient-to-r from-rose-300 to-violet-300 shadow hover:shadow-lg transition text-sm">
      ← Seanslara Dön
    </a>
  </div>

  <!-- Kısa Özet -->
  <div class="grid sm:grid-cols-4 gap-3 mt-5">
    <div class="rounded-2xl bg-white/80 ring-1 ring-white/60 shadow-inner p-3 text-center">
      <div class="text-xs text-stone-500">Toplam Kayıt</div>
      <div class="text-lg font-semibold">{{ parts|length }}</div>
    </div>
    <div class="rounded-2xl bg-white/80 ring-1 ring-white/60 shadow-inner p-3 text-center">
      <div class="text-xs text-stone-500">Aktif</div>
      <div class="text-lg font-semibold">
        {{ parts|selectattr('status','equalto','active')|list|length }}
      </div>
    </div>
    <div class="rounded-2xl bg-white/80 ring-1 ring-white/60 shadow-inner p-3 text-center">
      <div class="text-xs text-stone-500">Katıldı</div>
      <div class="text-lg font-semibold">
        {{ parts|selectattr('status','equalto','attended')|list|length }}
      </div>
    </div>
    <div class="rounded-2xl bg-white/80 ring-1 ring-white/60 shadow-inner p-3 text-center">
      <div class="text-xs text-stone-500">İptal</div>
      <div class="text-lg font-semibold">
        {{ parts|selectattr('status','equalto','canceled')|list|length }}
      </div>
    </div>
  </div>

  <!-- Katılımcı listesi -->
  <div class="space-y-3 mt-5">
    {% for r in parts %}
      <div class="rounded-2xl bg-white/80 ring-1 ring-white/60 shadow-inner p-4 flex items-center justify-between">
        <div>
          <div class="font-medium">{{ r.user_name }}</div>
          <div class="text-xs text-stone-500 mt-0.5">
            Durum:
            {% if r.status == 'active' %}
              <span class="px-2 py-0.5 rounded-full bg-blue-200 text-blue-800">active</span>
            {% elif r.status == 'attended' %}
              <span class="px-2 py-0.5 rounded-full bg-green-200 text-green-800">attended</span>
            {% elif r.status == 'canceled' %}
              <span class="px-2 py-0.5 rounded-full bg-gray-300 text-gray-800">canceled</span>
            {% else %}
              <span class="px-2 py-0.5 rounded-full bg-purple-200 text-purple-800">{{ r.status }}</span>
            {% endif %}
            · Kayıt zamanı: {{ r.created_at.strftime('%d.%m.%Y %H:%M') }}
          </div>
        </div>

        <form method="post"
              action="{{ url_for('admin_cancel_reservation_refund', reservation_id=r.id) }}"
              onsubmit="return confirm('Bu rezervasyon iptal edilsin ve (gerekliyse) kredi iade edilsin mi?')">
          <button
            class="px-3 py-2 rounded-xl text-sm shadow
                   {% if r.status == 'canceled' %} bg-gray-300 cursor-not-allowed opacity-60 {% else %} bg-gradient-to-r from-rose-300 to-violet-300 hover:shadow-lg transition {% endif %}"
            {% if r.status == 'canceled' %}disabled{% endif %}>
            İptal + İade
          </button>
        </form>
      </div>
    {% else %}
      <div class="text-sm text-stone-500">Katılımcı yok.</div>
    {% endfor %}
  </div>

  <!-- Not -->
  <p class="text-xs text-stone-500 mt-4">
    Not: Seans tamamlandıysa ve katılımcı <strong>attended</strong> durumundaysa, iptal/iade işleminde kredi otomatik olarak geri verilir.
    Seans tamamlanmadıysa kredi zaten düşülmediği için ekstra iade yapılmaz.
  </p>

</div>
{% endblock %}
